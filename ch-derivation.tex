
\section{Derivation of TG-NDA}
A condensed version of this derivation first appeared in our previous work \cite{Ramirez2017}. In this chapter, we derive the formulation with more a detailed explanation.

Consider the first order, fixed-source, multigroup, steady state, \sn\ transport equation with isotropic scattering and fixed source, where $\rg$ is the group index and $n$ is the angle index:
  \begin{equation}
  \vec{\Omega}_{n,\rg}\cdot \nabla \psi_{n,\rg} \left(\vec{r}\right)+ \Sigma_{\mm{t},\rg}\left(\vec{r}\right)\psi_{n,\rg} = \frac{1}{4 \pi} \sum\limits_{\rg'=1}^\mm{G} \Sigma_{\mm{s},\rgp\to\rg}\left(\vec{r}\right) \phi_{\rg'}\left(\vec{r}\right) + \frac{1}{4 \pi} Q_\rg\:,
  \end{equation}
where $\phi_\rg = \sum\limits_{n=1}^N w_n \psi_{n, \rg}$. Here, we assume vacuum boundary conditions. 
% somewhere above you probably want to give the form for vacuum since you gave incoming. 
Using a similar technique as Peterson et al.\ used for the one-group case, we multiply by angular weights and sum to get the zeroth moment equation \cite{morel-holo}.
%
  \begin{equation}
  \nabla \cdot J_\rg + \Sigma_{r,\rg}\phi_g  = \sum_{\substack{\rg'=1 \\ \rg' \neq \rg}}^G \Sigma_{s,\rg' \rightarrow \rg}\phi_{\rg'} + Q_\rg\:,
  \label{eq:zeroth_moment}
  \end{equation}
where $J_\rg = \sum\limits_{n=1}^{N}w_n \vec{\Omega}\psi_{n, \rg}$ and the removal cross section, $\Sigma_{r, \rg} = \Sigma_{t, \rg} - \Sigma_{s, \rg \rightarrow \rg}$ . 
  Now consider the first moment equation:
  \begin{equation}
  \nabla \cdot \overset{\text{\scriptsize$\leftrightarrow$}}{P_\rg} + \Sigma_{t, \rg} J_\rg = 0\:,
  \end{equation}
where $\nabla \cdot \overset{\text{\scriptsize$\leftrightarrow$}}{P_\rg} =  \Omega_{n,\rg} \Omega_{n,\rg} \nabla \psi_{\rg}$. The first moment equation can be rewritten as
%
  \begin{equation}
  J_\rg = -\frac{1}{\Sigma_{t, \rg}} \nabla \cdot \overset{\text{\scriptsize$\leftrightarrow$}}{P_\rg} \:. 
  \end{equation}
  By adding and subtracting the diffusion coefficient, $D_\rg = \frac{1}{3\Sigma_{t, \rg}}$, multiplied by the gradient of the flux, the first moment equation takes the form of a correction to Fick's Law
  \begin{equation}
  J_\rg = -D_\rg \nabla \phi_\rg + D_\rg \nabla \phi_\rg - \frac{1}{\Sigma_{t, \rg}} \nabla \cdot \overset{\text{\scriptsize$\leftrightarrow$}}{P_\rg} \\
  = -D_\rg \nabla \phi_\rg - \vec{\textbf{D}}_\rg \phi_\rg \:,
  \label{eq:fick_corr}
  \end{equation}
  where 
 \begin{equation}
  \vec{\textbf{D}}_\rg (\psi_\rg) = \frac{\sum\limits_{n=1}^N w_n [\frac{1}{\Sigma_t} \vec{\Omega}_\mrm \vec{\Omega}_n \cdot \nabla\psi_{n, \rg} - D_\rg \nabla \sum\limits_{n=1}^M w_n\psi_{n, \rg}]}{\sum\limits_{n=1}^N w_n \psi_{n, \rg}}.
  \end{equation} 
 Substituting Eqn.~\eqref{eq:fick_corr} into Eqn.~\eqref{eq:zeroth_moment}, we have the following NDA equation
  \begin{equation}
  \nabla\cdot(-D_\rg \nabla \phi_\rg - \vec{\bf D}_\rg \phi_\rg) + \Sigma_{r,\rg} \phi_\rg = \sum\limits_{\rgp\neq\rg}\Sigma_{\mm{s},\rg' \rightarrow \rg}\phi_{\rg'} + Q_\rg \:. \label{eq:NDA}
  \end{equation}
  
  The two grid method for upscatter acceleration involves two calculations at each iteration. We will refer to these intermediate calculations as half iterations. To add the upscatter acceleration, we must determine an equation for the error correction. We start with the $k + 1/2$ iteration, expressed as:
  \begin{equation}
  \begin{split}
  \nabla\cdot(-D_\rg \nabla \phi_\rg^{k+1/2} - \vec{\bf D}_\rg \phi_\rg^{k+1/2}) &+ \Sigma_{r,\rg} \phi_\rg^{k+1/2} =  \\ &\sum\limits_{\substack{\rg'=1}}^\mm{g-1} \Sigma_{\mm{s},\rg' \to\rg}\phi_{\rg}^{k+1/2} + \sum\limits_{\substack{\rg'=\rg+1}}^\mm{G} \Sigma_{\mm{s},\rg' \to\rg}\phi_{\rg'}^{k} + Q_\rg\:. 
  \end{split}
  \label{eq:k1/2}
  \end{equation}
  We next define two forms of error: the error of the scalar flux at each GS iteration, $\epsilon_\rg^{k+1/2}$, and the error in the scattering source from upscattering at each iteration, $R_\rg^{k+1/2}$
  \begin{equation}
  \epsilon_\rg^{k+1/2} := \phi_\rg - \phi_\rg^{k + 1/2} \quad \mm{and} \quad R_\rg^{k+1/2} := \sum\limits_{\rg'=\rg+1}^\mm{G} \Sigma_{\mm{s},\rg' \rg}\left(\phi_{\rg'}^k - \phi_{\rg'}^{k + 1/2}\right)\:.
  \end{equation}
  $\epsilon_\rg^{k + 1/2}$ can be further broken into the spatial component $\phi_{\epsilon}$ and scattering spectrum $\xi_\rg$ as defined in \cite{morel-upscat, evans-upscat}.
  \begin{equation}
  \epsilon_\rg^{k+1/2} = \phi_{\epsilon}^{k+1/2}\left(\vec{r}\right)\xi_\rg, \hspace{5mm} \sum\limits_{\rg=1}^G \xi_\rg = 1.
  \label{eq:decomp}
  \end{equation}
  
  We calculate $\xi$ using the procedure outlined in \cite{evans-upscat}. Performing a Fourier analysis of the Gauss Seidel iteration process, assuming isotropic scattering in an infinite medium, gives the following eigenproblem
  \begin{equation}
      (\textbf{T} - \textbf{S}_L - \textbf{S}_D)^{-1}\textbf{S}_U \xi = \rho(\lambda)\xi,
    \label{eq:eigenvector}
  \end{equation}
  where
  \begin{align*}
      \textbf{T} &= diag(\textbf{T}) =  \text{matrix of total cross sections by group} \\
      \textbf{S}_L &= lower(\textbf{S}) = \text{zeroth moments of the downscattering cross sections} \\
      \textbf{S}_D &= diag(\textbf{S}) = \text{zeroth moments of within group scattering cross sections} \\
      \textbf{S}_U &= upper(\textbf{S}) = \text{zeroth moments of the upscattering cross sections.}
  \end{align*}
  $\rho(\lambda)$ represents the eigenvalues of the system and $\xi$ is the eigenvector. The $\xi$ we are interested in is the eigenvector corresponding to the maximum absolute value eigenvalue of the system. $\xi_\rg$ is the $\rg$-th entry of that eigenvector. $\xi$ is material dependent and is recaluculated for each material in the problem.

  Subtracting Eqn.~\eqref{eq:k1/2} from Eqn.~\eqref{eq:NDA} and adding and subtracting $R_\rg^{k+1/2}$ gives an exact formulation of the error, but for the sake of efficiency, we approximate the error using the following diffusion approximation:
  \begin{equation}
  \nabla\cdot(-D_\rg  \nabla \epsilon_\rg^{k+1/2} - \vec{\bf D}_\rg
  \epsilon_\rg^{k+1/2}) + \Sigma_{r,\rg}  \epsilon_\rg^{k+1/2} =  \sum\limits_{\substack{\rgp\neq\rg}} \Sigma_{\mm{s},\rg' \to\rg}  \epsilon_{\rg'}^{k+1/2} -  R^{k+1/2}_\rg \:.
  \end{equation}
  Using the eigenvector calculated in Eqn.~\eqref{eq:eigenvector}, we split the error into spatial and energy components and then integrate over all groups to collapse into a one group equation
  \begin{equation}
  \nabla\cdot(-\left< D \xi \right> \nabla \phi_{\epsilon}^{k+1/2} - \left<\vec{\bf D} \xi
  \right> \phi_{\epsilon}^{k+1/2}) + \left< \Sigma_{a} \right> \phi_{\epsilon}^{k+1/2} = - \left< R^{k+1/2} \right> \:,\label{eq:collapsed}
  \end{equation}
  where $\left< X \right> = \sum\limits_{\rg = 1}^G X_\rg $ and $\Sigma_{a,\rg}  = \Sigma_{r,\rg}\xi_\rg - \sum\limits_{\rgp\neq\rg} \Sigma_{s,\rg'\rightarrow \rg} \xi_{\rg'}$.

  By solving Eqn.~\eqref{eq:collapsed} with the same spatial discretization as the NDA solve, we correct the scalar flux from the previous Gauss Seidel iteration as $\phi_\rg^{k+1} = \phi_\rg^{k+1/2} + \epsilon_\rg^{k+1/2}$.

  TG-NDA Update Procedure
  \begin{enumerate}
      \item Solve \eqref{eq:k1/2} using NDA iteration to find $\phi_\rg^{k+1/2}$ for each group, $\rg$. 
      \item Solve \eqref{eq:collapsed} to find $\phi_\epsilon^{k+1/2}$. 
      \item Solve \eqref{eq:eigenvector} to find $\xi$. 
      \item Use \eqref{eq:decomp} to find $\epsilon_\rg^{k+1/2}$ and apply to each group to get $\phi_\rg^{k+1}$ for all $\rg$. 
      \item Check for convergence between $\phi_\rg^{k+1}$ and $\phi_\rg^{k}$.
      \item Repeat until all groups have converged.
  \end{enumerate}
