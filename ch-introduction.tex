Nonlinear diffusion acceleration (NDA), also known as coarse-mesh finite difference, is a well-known technique applied to accelerate the scattering convergence in neutronics calculations. In multigroup neutronics problems, NDA is effective in conjunction with Gauss-Seidel (GS) iteration in energy if there is little upscattering. However, when upscattering manifests, which is common with thermal neutrons, the efficiency of GS-NDA degrades as extra iterations are required for convergence in energy \cite{park-nda}.

To remedy the issue in GS with upscattering, an energy two-grid (TG) acceleration scheme was first developed to approximate iteration error by solving a one-group diffusion-like equation with artificial material properties generated by using the scattering eigen-spectrum \cite{morel-upscat}. Later, a transport TG (TTG) method was developed that approximates the energy error using a consistent \sn\ solver in multi-D \cite{evans-upscat}. Inspired by the previous studies, we will derive a TG scheme for the NDA equation with GS iteration.

\section{Background}
\subsection{Motivation}
To accelerate the convergence of transport calculations, Nonlinear Diffusion Acceleration (NDA) was developed. It pairs a lower order equation with a higher order, drift diffusion equation. As the higher order equation is not conservative, formally the method is inconsistent: The scalar flux and current may not be equal upon convergence, although they are in the limit as the spatial mesh is refined. However, second order accuracy can still be maintained with the high-order equation generally giving a more accurate shape and the conservative low-order equation giving a more accurate magnitude. The combination of the two equations is more accurate than either equation alone. \cite{morel-holo} \par
NDA is an iterative method that uses the Gauss-Seidel method to reach convergence. Gauss-Siedel is guaranteed to converge eventually, however in problems with significant upscattering the time it takes to reach convergence can become arbitrarily slow. 
\par
A number of techniques to accelerate Gauss-Seidel convergence have been developed, although to our knowledge none have yet been paired with NDA.The primary techniques used in commercial transport software rely on a rebalance scheme and coarse-mesh finite-difference diffusion. Although these methods are widely used and successful for accelerating \textit{k}-eigenvalue problems, they are very sensitive to the coarse mesh size. Rebalancing with too fine a mesh may be divergent, and an overly coarse mesh degrades performance. \cite{evans-upscat}
\par
While for standard problems, the proper mesh size is generally well understood, this is not the case for shielding problems. Adams and Morel developed an upscatter acceleration scheme known as the Two-Grid method. An estimation of the error at each Gauss-Seidel iteration is calculated using a collapsed in energy, one-group diffusion equation and energy eigenfunctions of the Gauss-Seidel iteration matrix. These make up the correction term to the scalar flux at each group which is applied at each iteration. In one dimensional calculations, Adams and Morel have demonstrated their method to be very efficient for thermal upscattering problems. \cite{morel-upscat}

\section{The Boltzmann Transport Equation}
The angular neutron flux of a reactor, $\psi$ can be described by the steady state Boltzmann Transport equation.

\begin{equation}
\begin{split}
 [\hat{\Omega} \cdot \nabla + \Sigma(\vec{r}, E)]\psi(\vec{r}, \hat{\Omega}, E) &= \chi(E) \int_0^\infty dE' \nu \Sigma_{f}(\vec{r}, E') \int_{4\pi} d\hat{\Omega}', E') \\   &+ \int_0^\infty dE' \int_{4\pi} d\hat{\Omega}' \Sigma_s(\vec{r}, E' \rightarrow E, \hat{\Omega}' \cdot \hat{\Omega})\psi(\vec{r}, \hat{\Omega}', E')   
\end{split}
\label{eq:transport}
\end{equation}


where $\hat{\Omega}$ represents the angle; $\vec{r}$, the position vector; $E$, the energy; $\Sigma$, the total macroscopic cross-section; $\Sigma_f$, the macroscopic fission cross-section; $\Sigma_s$, the macroscopic scattering cross section; $\chi$, the energy distribution; and $\nu$, the average number of neutrons per fission. 

This equation gives the angular flux. To find the scalar flux, $\phi$ we must integrate over all directions.
\begin{equation}
    \phi(\vec{r}, E) = \int_{4\pi} \phi(\vec{r}, \hat{\Omega}, E) d \Omega.
\end{equation}

\subsection{Forms of the Transport Equation}
There are two forms of the transport equation that are considered in this work: fixed source and $k$-eigenvalue. 

\subsubsection{Fixed Source Form}
In the fixed source form, we assume there is no fission and that there is an external neutron source, $Q$.

\begin{align}
 [\hat{\Omega} \cdot \nabla + \Sigma(\vec{r}, E)]\psi(\vec{r}, \hat{\Omega}, E) &= \\ \int_0^\infty dE' &\int_{4\pi} d\hat{\Omega}' \Sigma_s(\vec{r}, E' \rightarrow E, \hat{\Omega}' \cdot \hat{\Omega})\psi(\vec{r}, \hat{\Omega}', E')  +Q \nonumber
 \label{eq:transport_fixed_source}
\end{align}

\subsubsection{$k$-Eigenvalue Form}
If the chain reaction is self-sustaining and time-independent, the reactor is known as ``critical." To maintain criticality, the asymptotic neutron distribution must not be changing over time. This behavior can be described by a parameter,  $k$, the ratio of neutrons in two successive generations. We scale $\nu$ in Eq. \ref{eq:transport} by $k$ to express the deviation from critical. This gives the following equation,

\begin{equation}
    \label{eq:transport_eigenvalue}
    \begin{split}
        [\hat{\Omega} \cdot \nabla + \Sigma(\vec{r}, E)]\psi(\vec{r}, \hat{\Omega}, E) &= \frac{\chi(E)}{k} \int_0^\infty dE' \nu \Sigma_{f}(\vec{r}, E') \int_{4\pi} d\hat{\Omega}', E') \\ &+ \int_0^\infty dE' \int_{4\pi} d\hat{\Omega}' \Sigma_s(\vec{r}, E' \rightarrow E, \hat{\Omega}' \cdot \hat{\Omega})\psi(\vec{r}, \hat{\Omega}', E') 
    \end{split}
\end{equation}

Eq. \ref{eq:transport_eigenvalue} is simply an eigenvalue problem that with some algebraic manipulation can be thought of in the form $A\psi = \frac{1}{k} \psi$ and solved via standard eigenvalue solvers. 

\section{Methods of Discretization}
The angular flux, $\psi$, is a function of space, angle, and energy. In the solution process, each one of those dimensions is discretized. There are several choices that have to be made when choosing discretizations. In this work, we endeavor to show equation forms that are discretization agnostic as well as showing formulations unique to the particular discretization methods we chose to implement. 
\subsection{Spatial Discretization}
In this work, we choose to discretize in two dimensions, assuming uniformity in the third, however all formulations could be extended to be truly 3D. Spatial discretization methods for the transport equation is usually performed using commonly known differential equation discretization techniques such as the finite difference, finite volume, or finite element methods. In this work we discretize using the finite element method (described in detail in section \ref{sec:spatial}, however the form of TG-NDA given can be used with any spatial discretization. 

\subsection{Angular Discretization}
The angular flux is converted to a scalar flux by integrating over all dimensions. Numerically, we cannot integrate over \textit{all} dimensions, so instead a numerical quadrature is performed by choosing certain angles to be representative. \todo{Add more information about different angular quadrature sets} To perform this quadrature, we use the discrete ordinates method. The general $S_N$ equation for obtaining scalar flux from angular flux is
\begin{equation}
    \phi = \sum\limits_{m=1}^{M}\psi_m w_m
\end{equation}
where $m$ is the angular index and $w_m$ is the quadrature weight associated with the $m$'th quadrature cosine $\mu_m$. We are using a $S_4$ quadrature which has weights of $\frac{1}{3}$ for every $\mu_m$.

\subsection{Energy Discretization}
In our treatment of energy, we divide the full energy spectrum into several energy groups. By convention, the highest energy group is given the index, 1, with the index number going up until it reaches the lowest energy group. \todo{Figure out where xs data is coming from. Add more}

\section{Approximations to the Transport Equation}
The transport equation requires a significant amount of computational power to solve, so often simpler approximations are used in its place. Here we will introduce the three that are most relevant to this work.

\subsection{Neutron Diffusion}
The diffusion equation is one of the most commonly used approximations. It is derived by integrating over all angles in the transport equation. We assume the scattering term is symmetric azimuthally, and both the scattering and angular flux are linearly anisotropic. Those assumptions give the following fixed source form:
\begin{equation}
\begin{split}
 - \nabla \cdot D(\vec{r}, E)\nabla\phi(\vec{r}, E, t) &+ \Sigma_r \phi(\vec{r}, E, t) = Q
\end{split}
\label{eq:diffusion_fixed_source}
\end{equation}
where $D$, known as the diffusion coefficient, is equal to $\frac{1}{3\Sigma_t}$, $\Sigma_r = \Sigma_t - \Sigma_{s, g \rightarrow g}$ and $g$ represents the group index. 

The $k$-eigenvalue form of the equation is given as:
\begin{equation}
    \begin{split}
         - \nabla \cdot D(\vec{r}, E)\nabla\phi(\vec{r}, E, t) + \Sigma_r \phi(\vec{r}, E, t) =  \frac{\chi}{k}\nu\Sigma_f\phi(\vec{r}, E, t) 
    \end{split}
    \label{eq:diffusion_eigenvalue}
\end{equation}

\subsection{Nonlinear Diffusion Acceleration}
While the assumptions of the diffusion equation greatly simplify the mathematics, they do not always accurately represent the physics of a reactor. Nonlinear Diffusion Acceleration, the approximation on which this work is based, improves on the accuracy of diffusion by introducing a corrective term called the drift vector. The fixed source is given 

\begin{equation}
  \nabla\cdot(-D_\rg \nabla \varphi_\rg - \vec{\bf D}_\rg \varphi_\rg) + \sigma_{r,\rg} \varphi_\rg = \sum\limits_{\rgp\neq\rg}\sigma_{\mm{s},\rg' \rightarrow \rg}\varphi_{\rg'} + Q_\rg(\vec{r}) \:, \label{eq:NDA_fixed_source}
  \end{equation}
  where the drift vector $\vec{\bf D}_\rg$ is defined as
  \begin{equation}
  \vec{\bf D}_\rg= \frac{\sum_{\mrm=1}^M \omega_{\mrm, \rg} [\frac{1}{\sigma_t} \vec{\Omega}_{\mrm, \rg} \vec{\Omega}_{\mrm, \rg} \cdot \nabla\psi_{\mrm, \rg}] - D_\rg \nabla \phi_\rg}{\phi_\rg}\:. \label{eq:drift_vector}
  \end{equation}
 
 The eigenvalue form looks like:
 \begin{equation}
  \nabla\cdot(-D_\rg \nabla \varphi_\rg - \vec{\bf D}_\rg \varphi_\rg) + \sigma_{r,\rg} \varphi_\rg = \sum\limits_{\rgp\neq\rg}\sigma_{\mm{s},\rg' \rightarrow \rg}\varphi_{\rg'} +  \frac{\chig}{k} \sum\limits_{\rg'=1}^\mm{G} \nu \sigma_{\mm{f},\rg'}\left(\vec{r}\right) \varphi_\rgp\left(\vec{r}\right) \:, \label{eq:NDA_eigenvalue}
  \end{equation}

\subsection{Self-Adjoint Angular Flux}
In calculating the drift vector in the NDA equations, we use the scalar flux calculated by a ``higher-order equation." In this case, we will be using the Self-Adjoint Angular Flux Equation (SAAF) \cite{saaf} as our higher order equation. 

The monoenergetic version of the Self-Adjoint Angular Flux equation appropriate for $S_n$ calculations is as follows:
\begin{equation}
    - \vec{\Omega} \cdot \vec{\nabla}\frac{1}{\sigma_t}\vec{\Omega} \cdot \vec{\nabla} \psi + \sigma_t \psi = S\psi + q - \vec{\Omega} \cdot \vec{\nabla} \frac{(S\psi + q)}{\sigma_t}
    \label{eq:SAAF}
\end{equation}
Where $\vec{\Omega}$ are the angles, $\sigma_t$ is the total cross section, $\psi$ is the angular flux, $S\psi$ is the scattering source, and $q$ is the fixed source (for ease, we write $S\psi + q$ as $Q$ to represent the total source.

The eigenvalue formulation is
\begin{equation}
        - \vec{\Omega} \cdot \vec{\nabla}\frac{1}{\sigma_t}\vec{\Omega} \cdot \vec{\nabla} \psi + \sigma_t \psi = S\Psi + \frac{1}{k}\frac{\chi}{4\pi}\nu\sigma_f\phi - \vec{\Omega} \cdot \vec{\nabla} \frac{(S\Psi + \frac{1}{k}\frac{\chi}{4\pi}\nu\sigma_f\phi)}{\sigma_t}
    \label{eq:SAAF-eigenvalue}
\end{equation}